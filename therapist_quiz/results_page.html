<script>
  const allTherapists = ["LL", "SN", "XW", "NR", "SG", "JC", "MD"];

  const outcomeTitleWording = {
      quizOne: {
          a: 'adults',
          b: 'children',
          c: 'adolescents',
          d: 'relationships/families'
        },
      quizTwo: {
          a: 'currently taking on new clients',
          b: 'available on weekends',
          c: 'available on weekdays',
          d: 'available evenings',
        },
      quizThree: {
          a: 'BIPOC, LGBTQ+, and marginalized folks',
          b: 'Food/Body Image issues',
          c: 'EMDR/Brainspotting'
        },
      // NOTE: The way the phrase is constructed,
      // the language question must always be the last,
      // even if additional questions are added
      quizFour: {
          a: 'English',
          b: 'Mandarin',
          c: 'Cantonese',
          d: 'Hindu, Urdu, or Punjabi',
          e: 'Taglish',
        }
    };

    const outcomeKey = {
        // What counselling session type are you looking for?
        quizOne: {
            // Adults
            a: allTherapists,
            // Child
            b: ["SN"],
            // Adolescent
            c: allTherapists,
            // Relationship/Family
            d: ["SN", "XW", "JC"]
          },
        // When are you free?
        quizTwo: {
            // Taking on new clients
            a: ["SN", "JC", "SG", "MD"],
            // Weekends
            b: ["JC", "SG", "MD"],
            // Weekdays
            c: allTherapists,
            // Evenings
            d: ["LL", "SN", "NR", "MD", "SG"],
            // N/A
            e: allTherapists
          },
        // Are you needing any specialized offerings our therapist team offers?
        quizThree: {
            // BIPoC
            a: allTherapists,
            // Food/Body Image
            b: ["LL", "MD"],
            // EMDR/Brainspotting
            c: ["LL", "SN", "NR", "MD"],
            // N/A
            d: allTherapists
          },
        // Language
        quizFour: {
            // English
            a: allTherapists,
            // Mandarin
            b: ["LL", "SN", "XW"],
            // Cantonese
            c: ["SN"],
            // Indian
            d: ["SG"],
            // Taglish
            e: ["JC"]
          }
      };

    // Finds the common intersection between all lists given. This is
    // used in the therapist quiz to find matching therapists that
    // intersect between all choices the user made
    function intersection() {
        var result = [];
        var lists;

        if(arguments.length === 1) {
            lists = arguments[0];
          } else {
              lists = arguments;
            }

        for(var i = 0; i < lists.length; i++) {
            var currentList = lists[i];
            for(var y = 0; y < currentList.length; y++) {
                var currentValue = currentList[y];
                if(result.indexOf(currentValue) === -1) {
                    if(lists.filter(function(obj) { return obj.indexOf(currentValue) == -1 }).length == 0) {
                        result.push(currentValue);
                      }
                  }
              }
          }
        return result;
      }

    function makeEleVisible(ele, visible) {
        if (visible) {
            ele.classList.remove('decipher-quiz-result-hide');
          } else {
              ele.classList.add('decipher-quiz-result-hide');
            }
      }

    function wrapTitleWording(wording) {
        return `<b class='decipher-quiz-result-title-variable'>${wording}</b>`;
      }

    function injectOutcomeTitleWording(answers) {
        // If a wording is undefined, it means that they chose a N/A answer
        // and we can skip including that in the final phrase.
        const wordingOne = outcomeTitleWording.quizOne[answers.quizOne];
        const wordingTwo = outcomeTitleWording.quizTwo[answers.quizTwo];
        const wordingThree = outcomeTitleWording.quizThree[answers.quizThree];
        const wordingFour = outcomeTitleWording.quizFour[answers.quizFour];
        let phrase = 'Here are the therapists that work well with ' +
          `${wrapTitleWording(wordingOne)}`;

        // i.e. "are [available on weekends/etc...]"
        if (wordingTwo) {
            phrase = phrase + `, are ${wrapTitleWording(wordingTwo)}`;
          }

        // i.e "specialize in [the BIPoC community/etc...]"
        if (wordingThree) {
            phrase = phrase + `, specialize in ${wrapTitleWording(wordingThree)}`;
          }

        // i.e. "and consult in [English/etc...]"
        phrase = phrase + ` and consult in ${wrapTitleWording(wordingFour)}`;

        const ele = document.querySelector('.decipher-quiz-result-title-wording');
        ele.innerHTML = phrase;
      }

    function processOutcome() {
        const answers = {
            quizOne: sessionStorage.getItem('quizOne'),
            quizTwo: sessionStorage.getItem('quizTwo'),
            quizThree: sessionStorage.getItem('quizThree'),
            quizFour: sessionStorage.getItem('quizFour')
          };

        const questionNames = Object.keys(answers);

        // For each quiz question param, append the therapists
        // that matched the user's choice to a tally list
        // i.e. [["LL", "SX"], ["LL", "NR", "SG"], ...]
        const tallyList = questionNames.reduce(function(accum, question) {
            const possibleAnswers = Object.keys(outcomeKey[question]);
            const userChoice = answers[question];

            if (possibleAnswers.includes(userChoice)) {
                const outcome = outcomeKey[question][userChoice];
                return accum.concat([outcome]);
              }

            return accum;
          }, []);

        // Finds the intersection of therapists that match
        // all conditions of the quiz
        const matches = intersection(tallyList);

        injectOutcomeTitleWording(answers);

        makeEleVisible(document.querySelector('.decipher-quiz-result-spinner'), false);
        makeEleVisible(document.querySelector('.decipher-quiz-result-title'), true);
        makeEleVisible(document.querySelector('.decipher-quiz-result-profiles'), true);

        matches.forEach(function(match) {
            makeEleVisible(document.querySelector(`.decipher-quiz-result-profile-${match}`), true);
          });

      }

    document.addEventListener('readystatechange', function(event) {
        if (event.target.readyState === "complete") {
            processOutcome();
          }
      });
</script>

<style>
.decipher-quiz-result-hide {
  display: none;
}

  .decipher-quiz-result-profiles {
    display: flex;
    flex-wrap: wrap;
  }

  .decipher-quiz-result-profile {
    padding: 8px;
  }

  .decipher-quiz-result-profile > a > img {
    height: 300px;
    width: 200px;
    border: 1px solid black;
    object-fit: cover;
  }

  .decipher-quiz-result-profile > a > p {
    font-size: 24px !important;
    padding: 8px;
  }

  .decipher-quiz-result-title {
    margin-bottom: 64px;
  }

  .decipher-quiz-result-title-variable {
    text-decoration: underline;
  }

  .decipher-quiz-result-title > p {
    font-size: 12px;
  }

  .decipher-quiz-result-therapist-directory-link {
    font-weight: bold;
    text-decoration: underline;
  }
</style>

<div>
  <h3 class="decipher-quiz-result-spinner">Processing your results now...</h3>
  <div class="decipher-quiz-result-title decipher-quiz-result-hide">
    <h3 class='decipher-quiz-result-title-wording'></h3>
    <p>To see all therapists, <a class="decipher-quiz-result-therapist-directory-link" href="https://deciphercounselling.com/therapist-directory">visit our therapist directory</a></p>
  </div>
  <div class="decipher-quiz-result-profiles decipher-quiz-result-hide">
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-MD decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/maryamdada">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/5c8e87dd-2438-4f9c-ba99-95c5fbd7e64a/DECIPHER_EDITED_7+copy.png?format=750w" />
        <p>Maryam Dada</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-NR decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/natasha-roop">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/2fbfd1a5-ae7c-4b7d-bb8d-ce43ae74efe6/DECIPHER_EDITED_4+copy.png?format=750w" />
        <p>Natasha Roop</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-LL decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/linda-lin">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/26d1040c-7f8b-4ee3-a2d0-98a38d8eeab7/Decipher-Edited-6.jpg" />
        <p>Linda Lin</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-SN decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/stephanie-ng">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/7f09a2f9-c6ca-4fd5-abea-27524361fc5a/decipher-counselling-stephanie-ng.jpg" />
        <p>Stephanie Ng</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-XW decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/xu-wang">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/53cdf53b-5ee9-4ea0-b0ad-dc8f469c6954/DECIPHER_EDITED_5+copy.png?format=750w" />
        <p>Xu Wang</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-JC decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/jay-castro">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/67e5cf59-e25d-4c85-b352-512e1eb61798/profile-photo.jpg" />
        <p>Jay Castro</p>
      </a>
    </div>
    <div class="decipher-quiz-result-profile decipher-quiz-result-profile-SG decipher-quiz-result-hide">
      <a href="https://deciphercounselling.com/practitioners/sun-gupta">
        <img src="https://images.squarespace-cdn.com/content/v1/5ae7f1bb266c07f90cfec5be/ff1e0b86-2a9e-4092-923e-914e63df1e92/Sun.png" />
        <p>Sun Gupta</p>
      </a>
    </div>
  </div>
</div>
